<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <!-- Platform-specific variables matching original WiX 3 installer -->
  <?if $(var.Platform)=x64 ?>
    <?define msiUpgradeCode = "A7EAB3EB-6524-4173-B5D8-25FC867BD29E" ?>
    <?define msiProductName = "DirectOutput64" ?>
    <?define msiBitness = "64" ?>
    <?define Win64 = "yes" ?>
    <?define BinDirName = "x64" ?>
    <?define ProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else?>
    <?define msiUpgradeCode = "94E0D0EE-C078-42C6-AD9F-4030B329A040" ?>
    <?define msiProductName = "DirectOutput32" ?>
    <?define msiBitness = "32" ?>
    <?define Win64 = "no" ?>
    <?define BinDirName = "x86" ?>
    <?define ProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif?>

  <Package Name="$(var.msiProductName)" Language="1033" Version="3.2.9407.22473" Manufacturer="DirectOutput" UpgradeCode="$(var.msiUpgradeCode)" InstallerVersion="200" Scope="perUser">
    <SummaryInformation Keywords="Installer" Description="DirectOutput $(var.msiBitness)-bit Framework" Manufacturer="DirectOutput" />
    
    <!-- Retrieve the old install folder from the registry, if set (per-user only) -->
    <Property Id="INSTALLFOLDER" Value="C:\DirectOutput">
      <RegistrySearch Id="InstallFolder" Type="raw" Root="HKCU" Key="SOFTWARE\DirectOutput\DirectOutput" Name="InstallPath" />
    </Property>
    
    <!-- Standard upgrade handling for per-user installations -->
    <MajorUpgrade 
      DowngradeErrorMessage="A newer version of [ProductName] is already installed." 
      AllowSameVersionUpgrades="yes"
      RemoveFeatures="ALL" />
    
    <!-- Ensure we can upgrade from any previous version with same upgrade code -->
    <Upgrade Id="$(var.msiUpgradeCode)">
      <UpgradeVersion Minimum="1.0.0.0" Maximum="3.2.9407.22473" 
                      IncludeMinimum="yes" IncludeMaximum="no" 
                      Property="PREVIOUSVERSIONSINSTALLED" 
                      MigrateFeatures="yes" />
    </Upgrade>
    
    <MediaTemplate EmbedCab="yes" />
    
    <!-- Basic installer properties -->
    <Property Id="ARPPRODUCTICON" Value="DirectOutputIcon" />
    <Icon Id="DirectOutputIcon" SourceFile="..\DirectOutput\DirectOutputIcon_32.ico" />
    
    <!-- Enable basic Windows Installer UI with directory selection -->
    <Property Id="MSIUSEREALADMINDETECTION" Value="1" />
    
    <!-- Custom UI with embedded bitmaps -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <!-- WiX UI customization variables -->
    <WixVariable Id="WixUICostingPopupOptOut" Value="1" Overridable="yes" />
    <WixVariable Id="WixUILicenseRtf" Value="Res\DOFLicense.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="Res\Banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="Res\DialogSide.bmp" />
    
    <!-- UI bitmap resources with standard WiX names -->
    <Binary Id="WixUI_Bmp_Banner" SourceFile="Res\Banner.bmp" />
    <Binary Id="WixUI_Bmp_Dialog" SourceFile="Res\DialogSide.bmp" />
    
    <UI>
      <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
      <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
      <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />
      
      <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
      
      <!-- Reference standard dialogs -->
      <DialogRef Id="BrowseDlg" />
      <DialogRef Id="DiskCostDlg" />
      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <DialogRef Id="PrepareDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ResumeDlg" />
      <DialogRef Id="UserExit" />
      
      <!-- Welcome and Install Directory dialogs -->
      <DialogRef Id="WelcomeDlg" />
      <DialogRef Id="InstallDirDlg" />
      <DialogRef Id="VerifyReadyDlg" />
      
      <!-- Fixed dialog flow that properly updates INSTALLFOLDER -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" />
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1" />
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="2" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1" />
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2" />
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="1" Condition="NOT Installed" />
      <Publish Dialog="BrowseDlg" Control="OK" Event="SetTargetPath" Value="[_BrowseProperty]" Order="1" />
      <!-- This is the key fix - properly set INSTALLFOLDER when browse dialog closes -->
      <Publish Dialog="BrowseDlg" Control="OK" Event="DoAction" Value="SetInstallFolder" Order="2" />
    </UI>
    
    <!-- Custom action to properly update INSTALLFOLDER from browse selection -->
    <CustomAction Id="SetInstallFolder" Property="INSTALLFOLDER" Value="[_BrowseProperty]" Execute="immediate" />
    
    <Feature Id="ProductFeature" Title="DirectOutput" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>
    
    <!-- Custom Actions for PinballX and B2S Server Integration -->
    <Binary Id="B2SFixupDLL" SourceFile="..\DOFSetupB2SFixup\bin\$(var.Platform)\$(var.Configuration)\DOFSetupB2SFixup.dll" />
    <CustomAction Id="B2SFixup" Return="ignore" Execute="deferred" DllEntry="B2SFixup" Impersonate="yes" BinaryRef="B2SFixupDLL" />
    
    <Binary Id="PBXFixupDLL" SourceFile="..\DOFSetupPBXFixup\bin\$(var.Platform)\$(var.Configuration)\DOFSetupPBXFixup.dll" />
    <CustomAction Id="PBXFixup" Return="ignore" Execute="deferred" DllEntry="PBXFixup" Impersonate="yes" BinaryRef="PBXFixupDLL" />
    
    <!-- Property setters for custom actions -->
    <CustomAction Id="SetB2SVars" Return="check" Property="B2SFixup" Value="INSTALLEDPATH=[DOFDIR];BINDIR=$(var.BinDirName);BITNESS=$(var.msiBitness)" />
    <CustomAction Id="SetPBXVars" Return="check" Property="PBXFixup" Value="INSTALLEDPATH=[DOFDIR];BINDIR=$(var.BinDirName);BITNESS=$(var.msiBitness)" />

    <!-- Custom action execution sequence -->
    <InstallExecuteSequence>
      <Custom Action="SetB2SVars" Before="B2SFixup" />
      <Custom Action="B2SFixup" Before="InstallFinalize" Condition="NOT REMOVE=&quot;ALL&quot;" />
      <Custom Action="SetPBXVars" Before="PBXFixup" />
      <Custom Action="PBXFixup" Before="InstallFinalize" Condition="NOT REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>
  </Package>

  <Fragment>
    <!-- Install to user-selected folder with x86/x64 subdirectories for coexistence -->
    <Directory Id="WINDOWSVOLUME">
      <Directory Id="INSTALLFOLDER">
        <Directory Id="DOFDIR">
          <!-- Platform-specific subdirectory for executables -->
          <Directory Id="BINDIR" Name="$(var.BinDirName)" />
          <!-- Configuration directory -->
          <Directory Id="DOFCONFIGDIR" Name="Config">
            <Directory Id="DOFCONFIGEXAMPLESDIR" Name="Examples" />
          </Directory>
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents">
      <!-- Core DirectOutput DLL in platform subdirectory (BinFiles) -->
      <Component Id="DirectOutputDll" Directory="BINDIR" Guid="*">
        <File Id="DirectOutputDll" Source="..\bin\$(var.Platform)\Release\DirectOutput.dll" KeyPath="yes" />
      </Component>
      
      <!-- Configuration files in Config folder (SampleConfigFiles) -->
      <Component Id="CabinetXml" Directory="DOFCONFIGDIR" Guid="*">
        <File Id="CabinetXml" Source="..\config\examples\Cabinet.xml" KeyPath="yes" />
      </Component>
      
      <Component Id="GlobalConfigB2S" Directory="DOFCONFIGDIR" Guid="*">
        <File Id="GlobalConfigB2S" Source="..\config\examples\GlobalConfig_B2SServer.xml" KeyPath="yes" />
      </Component>
      
      <!-- COM Object files in root DirectOutput folder -->
      <Component Id="ComObjectDll" Directory="DOFDIR" Guid="*">
        <File Id="ComObjectDll" Source="..\bin\$(var.Platform)\Release\DirectOutputComObject.dll" KeyPath="yes" />
        <RegistryKey Root="HKCR" Key="CLSID\{A23BFDBC-9A8A-46C0-8672-60F23D54FFB6}">
          <RegistryValue Type="string" Value="DirectOutput COM Object" />
          <RegistryKey Key="InprocServer32">
            <RegistryValue Type="string" Value="[#ComObjectDll]" />
            <RegistryValue Name="ThreadingModel" Type="string" Value="Both" />
          </RegistryKey>
        </RegistryKey>
      </Component>
      
      <Component Id="ComObjectTlb" Directory="DOFDIR" Guid="*">
        <File Id="ComObjectTlb" Source="..\bin\$(var.Platform)\Release\DirectOutputComObject.tlb" KeyPath="yes" />
      </Component>
      
      <!-- Resources in root DirectOutput folder (DofFiles) -->
      <Component Id="DirectOutputShapesPng" Directory="DOFDIR" Guid="*">
        <File Id="DirectOutputShapesPng" Source="..\bin\$(var.Platform)\Release\DirectOutputShapes.png" KeyPath="yes" />
      </Component>
      
      <Component Id="DirectOutputShapesXml" Directory="DOFDIR" Guid="*">
        <File Id="DirectOutputShapesXml" Source="..\bin\$(var.Platform)\Release\DirectOutputShapes.xml" KeyPath="yes" />
      </Component>
      
      <!-- License in root DirectOutput folder (DofFiles) -->
      <Component Id="LicenseFile" Directory="DOFDIR" Guid="*">
        <File Id="LicenseFile" Source="..\LICENSE" KeyPath="yes" />
      </Component>
      
      <!-- B2S Server Plugin in platform subdirectory (BinFiles) -->
      <Component Id="B2SServerPluginDll" Directory="BINDIR" Guid="*">
        <File Id="B2SServerPluginDll" Source="..\bin\$(var.Platform)\Release\B2SServerDirectOutputPlugin.dll" KeyPath="yes" />
      </Component>
      
      <!-- PinballX Plugin in platform subdirectory (BinFiles) -->
      <Component Id="PinballXPluginDll" Directory="BINDIR" Guid="*">
        <File Id="PinballXPluginDll" Source="..\bin\$(var.Platform)\Release\DirectOutput PinballX Plugin.dll" KeyPath="yes" />
      </Component>
      
      <!-- Tools in platform subdirectory (BinFiles) -->
      <Component Id="RegisterComObjectExe" Directory="BINDIR" Guid="*">
        <File Id="RegisterComObjectExe" Source="..\bin\$(var.Platform)\Release\RegisterDirectOutputComObject.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="ConfigTesterExe" Directory="BINDIR" Guid="*">
        <File Id="ConfigTesterExe" Source="..\bin\$(var.Platform)\Release\DirectOutputConfigTester.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="GlobalConfigEditorExe" Directory="BINDIR" Guid="*">
        <File Id="GlobalConfigEditorExe" Source="..\bin\$(var.Platform)\Release\GlobalConfigEditor.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="LedControlFileTesterExe" Directory="BINDIR" Guid="*">
        <File Id="LedControlFileTesterExe" Source="..\bin\$(var.Platform)\Release\LedControlFileTester.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="DOFSlaveExe" Directory="BINDIR" Guid="*">
        <File Id="DOFSlaveExe" Source="..\bin\$(var.Platform)\Release\DOFSlave.exe" KeyPath="yes" />
      </Component>
      
      <!-- Registry entry to save install path -->
      <Component Id="RegistryEntries" Directory="DOFDIR" Guid="*">
        <RegistryKey Root="HKCU" Key="SOFTWARE\DirectOutput\DirectOutput">
          <RegistryValue Type="string" Name="InstallPath" Value="[DOFDIR]" KeyPath="yes" />
        </RegistryKey>
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>